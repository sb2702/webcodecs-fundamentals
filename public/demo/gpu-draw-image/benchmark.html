<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VideoFrame Rendering Performance Benchmark</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .benchmark-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 20px 0;
    }
    .benchmark-card {
      border: 2px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    .benchmark-card.active {
      border-color: #4caf50;
      background: #f0f8f0;
    }
    .benchmark-card h3 {
      margin-top: 0;
    }
    canvas {
      border: 1px solid #999;
      display: block;
      width: 100%;
      background: #000;
      margin: 10px 0;
    }
    .controls {
      margin: 20px 0;
      text-align: center;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #2196f3;
      color: white;
      font-weight: bold;
    }
    button:hover {
      background: #1976d2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.stop {
      background: #f44336;
    }
    button.stop:hover {
      background: #d32f2f;
    }
    .stats {
      font-family: monospace;
      background: #f5f5f5;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      text-align: center;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    .stat-item {
      padding: 10px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .stat-value.good {
      color: #4caf50;
    }
    .stat-value.warning {
      color: #ff9800;
    }
    .stat-value.bad {
      color: #f44336;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .method-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    .badge-webgpu { background: #4caf50; color: white; }
    .badge-canvas2d { background: #2196f3; color: white; }
    .badge-bitmap { background: #ff9800; color: white; }
  </style>
</head>
<body>
  <h1>VideoFrame Rendering Performance Benchmark</h1>
  <p>Test raw rendering throughput of different methods. Each renders frames as fast as possible without throttling.</p>

  <div class="info">
    <strong>Methods:</strong>
    <ul>
      <li><strong>WebGPU (Zero-Copy)</strong> - Uses <code>importExternalTexture()</code> with no memory copies</li>
      <li><strong>Canvas 2D</strong> - Uses <code>ctx.drawImage()</code> with hardware acceleration</li>
      <li><strong>ImageBitmap</strong> - Uses <code>createImageBitmap()</code> + <code>transferFromImageBitmap()</code></li>
    </ul>
  </div>

  <div class="controls">
    <button id="initBtn">Load Video</button>
    <button id="webgpuBtn" disabled>Test WebGPU</button>
    <button id="canvas2dBtn" disabled>Test Canvas 2D</button>
    <button id="bitmapBtn" disabled>Test ImageBitmap</button>
    <button id="stopBtn" class="stop" disabled>Stop Test</button>
  </div>

  <div class="stats">
    <h3>Current Test: <span id="currentMethod">None</span></h3>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">Current FPS</div>
        <div class="stat-value" id="currentFps">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Frames Rendered</div>
        <div class="stat-value" id="framesRendered">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Avg Frame Time</div>
        <div class="stat-value" id="avgFrameTime">0ms</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Test Duration</div>
        <div class="stat-value" id="testDuration">0s</div>
      </div>
    </div>
  </div>

  <div class="benchmark-grid">
    <div class="benchmark-card" id="webgpuCard">
      <h3>WebGPU <span class="method-badge badge-webgpu">Zero-Copy</span></h3>
      <canvas id="webgpuCanvas" width="3840" height="2160"></canvas>
      <div class="stat-item">
        <div class="stat-label">Best Result</div>
        <div class="stat-value good" id="webgpuResult">-</div>
      </div>
    </div>

    <div class="benchmark-card" id="canvas2dCard">
      <h3>Canvas 2D <span class="method-badge badge-canvas2d">Standard</span></h3>
      <canvas id="canvas2dCanvas" width="3840" height="2160"></canvas>
      <div class="stat-item">
        <div class="stat-label">Best Result</div>
        <div class="stat-value" id="canvas2dResult">-</div>
      </div>
    </div>

    <div class="benchmark-card" id="bitmapCard">
      <h3>ImageBitmap <span class="method-badge badge-bitmap">Transfer</span></h3>
      <canvas id="bitmapCanvas" width="3840" height="2160"></canvas>
      <div class="stat-item">
        <div class="stat-label">Best Result</div>
        <div class="stat-value" id="bitmapResult">-</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { WebDemuxer } from 'https://cdn.jsdelivr.net/npm/web-demuxer/+esm';
    import { GPUDrawImage } from './GPUDrawImage.js';

    // Canvas elements
    const webgpuCanvas = document.getElementById('webgpuCanvas');
    const canvas2dCanvas = document.getElementById('canvas2dCanvas');
    const bitmapCanvas = document.getElementById('bitmapCanvas');

    // Button elements
    const initBtn = document.getElementById('initBtn');
    const webgpuBtn = document.getElementById('webgpuBtn');
    const canvas2dBtn = document.getElementById('canvas2dBtn');
    const bitmapBtn = document.getElementById('bitmapBtn');
    const stopBtn = document.getElementById('stopBtn');

    // Stats elements
    const currentMethodEl = document.getElementById('currentMethod');
    const currentFpsEl = document.getElementById('currentFps');
    const framesRenderedEl = document.getElementById('framesRendered');
    const avgFrameTimeEl = document.getElementById('avgFrameTime');
    const testDurationEl = document.getElementById('testDuration');

    // Result elements
    const webgpuResultEl = document.getElementById('webgpuResult');
    const canvas2dResultEl = document.getElementById('canvas2dResult');
    const bitmapResultEl = document.getElementById('bitmapResult');

    // Cards
    const webgpuCard = document.getElementById('webgpuCard');
    const canvas2dCard = document.getElementById('canvas2dCard');
    const bitmapCard = document.getElementById('bitmapCard');

    let chunks = [];
    let metaData = null;
    let decoder = null;
    let testRunning = false;
    let animationFrameId = null;

    // Decode state
    let decodeChunkIndex = 0;
    const BATCH_DECODE_SIZE = 10;
    const render_buffer = [];

    // Test state
    let testStartTime = 0;
    let framesRendered = 0;
    let frameTimes = [];
    let fpsCounter = 0;
    let fpsStartTime = 0;

    // Renderers
    let gpuRenderer = null;
    let canvas2dCtx = null;
    let bitmapCtx = null;
    let currentRenderer = null;

    async function init() {
      initBtn.disabled = true;
      currentMethodEl.textContent = 'Loading...';

      // Initialize renderers
      gpuRenderer = new GPUDrawImage(webgpuCanvas);
      await gpuRenderer.init();

      canvas2dCtx = canvas2dCanvas.getContext('2d');
      bitmapCtx = bitmapCanvas.getContext('bitmaprenderer');

      // Load video
      const demuxer = new WebDemuxer({
        wasmFilePath: "https://cdn.jsdelivr.net/npm/web-demuxer@latest/dist/wasm-files/web-demuxer.wasm",
      });

      const response = await fetch('test-outro-4k.mp4');
      const buffer = await response.arrayBuffer();
      const file = new File([buffer], 'test-outro-4k.mp4', {type: 'video/mp4'});

      await demuxer.load(file);
      const mediaInfo = await demuxer.getMediaInfo();
      const videoTrack = mediaInfo.streams.filter((s) => s.codec_type_string === 'video')[0];

      console.log(videoTrack)

      metaData = {
        codec: videoTrack.codec_string,
        width: videoTrack.width,
        height: videoTrack.height,
        description: videoTrack.extradata
      };

      chunks = await getChunks(demuxer);

      currentMethodEl.textContent = 'Ready';
      webgpuBtn.disabled = false;
      canvas2dBtn.disabled = false;
      bitmapBtn.disabled = false;
    }

    async function getChunks(demuxer, start = 0, end = undefined) {
      const reader = demuxer.read('video', start, end).getReader();
      const chunks = [];

      return new Promise(function(resolve) {
        reader.read().then(async function processPacket({ done, value }) {
          if (value) chunks.push(value);
          if (done) return resolve(chunks);
          return reader.read().then(processPacket);
        });
      });
    }

    function fillBuffer() {
      for (let i = 0; i < BATCH_DECODE_SIZE; i++) {
        if (decodeChunkIndex < chunks.length) {
          try {
            decoder.decode(chunks[decodeChunkIndex]);
            decodeChunkIndex += 1;
            if (decodeChunkIndex === chunks.length) {
              decodeChunkIndex = 0; // Loop
            }
          } catch (e) {
            console.error(e);
          }
        }
      }
    }

    function startTest(method, renderFn) {
      if (testRunning) return;

      testRunning = true;
      testStartTime = performance.now();
      framesRendered = 0;
      frameTimes = [];
      fpsCounter = 0;
      fpsStartTime = performance.now();
      decodeChunkIndex = 0;
      render_buffer.length = 0;

      currentMethodEl.textContent = method;
      currentRenderer = renderFn;

      // Clear active states
      webgpuCard.classList.remove('active');
      canvas2dCard.classList.remove('active');
      bitmapCard.classList.remove('active');

      // Set active card
      if (method.includes('WebGPU')) webgpuCard.classList.add('active');
      if (method.includes('Canvas 2D')) canvas2dCard.classList.add('active');
      if (method.includes('ImageBitmap')) bitmapCard.classList.add('active');

      webgpuBtn.disabled = true;
      canvas2dBtn.disabled = true;
      bitmapBtn.disabled = true;
      stopBtn.disabled = false;

      // Create decoder
      decoder = new VideoDecoder({
        output: function(frame) {
          render_buffer.push(frame);
        },
        error: function(error) {
          console.error(error);
        }
      });

      decoder.configure({ codec: metaData.codec, description:metaData.description});

      fillBuffer();
      renderLoop();
    }

    function renderLoop() {
      if (!testRunning) return;

      const loopStart = performance.now();

      // Render available frames
      while (render_buffer.length > 0) {
        const frame = render_buffer.shift();
        const frameStart = performance.now();

        currentRenderer(frame);

        const frameTime = performance.now() - frameStart;
        frameTimes.push(frameTime);
        if (frameTimes.length > 100) frameTimes.shift();

        frame.close();
        framesRendered++;
      }

      // Fill buffer with more chunks
      if (render_buffer.length < 5) {
        fillBuffer();
      }

      // Update stats
      const elapsed = (performance.now() - testStartTime) / 1000;
      const currentFps = framesRendered / elapsed;

      currentFpsEl.textContent = Math.round(currentFps);
      framesRenderedEl.textContent = framesRendered;
      testDurationEl.textContent = elapsed.toFixed(1) + 's';

      if (frameTimes.length > 0) {
        const avgTime = frameTimes.reduce((a, b) => a + b, 0) / frameTimes.length;
        avgFrameTimeEl.textContent = avgTime.toFixed(2) + 'ms';
      }

      // Color code FPS
      if (currentFps > 120) {
        currentFpsEl.className = 'stat-value good';
      } else if (currentFps > 60) {
        currentFpsEl.className = 'stat-value';
      } else {
        currentFpsEl.className = 'stat-value warning';
      }

      animationFrameId = requestAnimationFrame(renderLoop);
    }

    function stopTest() {
      if (!testRunning) return;

      testRunning = false;
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }

      // Calculate final stats
      const elapsed = (performance.now() - testStartTime) / 1000;
      const finalFps = Math.round(framesRendered / elapsed);

      // Update result
      const method = currentMethodEl.textContent;
      if (method.includes('WebGPU')) {
        webgpuResultEl.textContent = finalFps + ' fps';
      } else if (method.includes('Canvas 2D')) {
        canvas2dResultEl.textContent = finalFps + ' fps';
      } else if (method.includes('ImageBitmap')) {
        bitmapResultEl.textContent = finalFps + ' fps';
      }

      // Clean up
      for (const frame of render_buffer) {
        frame.close();
      }
      render_buffer.length = 0;

      if (decoder && decoder.state !== 'closed') {
        decoder.close();
      }

      webgpuBtn.disabled = false;
      canvas2dBtn.disabled = false;
      bitmapBtn.disabled = false;
      stopBtn.disabled = true;

      webgpuCard.classList.remove('active');
      canvas2dCard.classList.remove('active');
      bitmapCard.classList.remove('active');

      currentMethodEl.textContent = 'Test Complete';
    }

    // Render functions
    function renderWebGPU(frame) {
      gpuRenderer.drawImage(frame);
    }

    function renderCanvas2D(frame) {
      canvas2dCtx.drawImage(frame, 0, 0, canvas2dCanvas.width, canvas2dCanvas.height);
    }

    async function renderBitmap(frame) {
      const bitmap = await createImageBitmap(frame);
      bitmapCtx.transferFromImageBitmap(bitmap);
    }

    // Event listeners
    initBtn.addEventListener('click', init);
    webgpuBtn.addEventListener('click', () => startTest('WebGPU (Zero-Copy)', renderWebGPU));
    canvas2dBtn.addEventListener('click', () => startTest('Canvas 2D (drawImage)', renderCanvas2D));
    bitmapBtn.addEventListener('click', () => startTest('ImageBitmap (transfer)', renderBitmap));
    stopBtn.addEventListener('click', stopTest);
  </script>
</body>
</html>
